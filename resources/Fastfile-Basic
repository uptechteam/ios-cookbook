default_platform(:ios)

platform :ios do
  before_all do
    setup_circle_ci
    ENV["SLACK_URL"] = ""
  end

  desc "Runs all the tests"
  lane :test do
    run_tests(
      scheme: 'AwesomeProject',
      device: 'iPhone 6s',
      skip_slack: true,
      output_types: "junit",
      output_files: "results.xml"
    )
  end

  lane :deploy do
    # Fetch provisioning profiles
    match(
      git_url: certificates_repo_url,
      type: "adhoc",
      readonly: true
    )

    # Build the project
    build_ios_app(
      scheme: 'AwesomeProject',
      export_method: "ad-hoc"
    )

    # Deploy to your builds distributor
    changelog = changelog_from_git_commits(merge_commit_filtering: "exclude_merges")
    hockey(
      api_token: "api_token",
      notes: changelog
    )

    version = get_version_number(xcodeproj: "AwesomeProject.xcodeproj")
    slack(
      message: "New iOS build *#{version}* (#{build_number}) has been submitted to HockeyApp!",
      use_webhook_configured_username_and_icon: true,
      success: true,
      default_payloads: [],
      payload: {
        "Git Commit": original_commit[:message],
        "Git Author": original_commit[:author]
      }
    )
  end

  error do |lane, exception, options|
    slack_train_crash

    slack(
      message: "*#{lane}* lane crashed: #{exception}",
      use_webhook_configured_username_and_icon: true,
      success: false,
      default_payloads: [:last_git_commit_message, :git_author]
    )
  end

  # we don't want to use ssh on the local machines
  def certificates_repo_url
    if is_ci?
      return "git@provider.com:certificates_repo_url.git"
    else
      return "https://provider.com/certificates_repo_url.git"
    end
  end

end
